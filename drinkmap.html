<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}
#map {
  height: 100%;
}
</style>
</head>
<body>
<script>
let map = null;
let centerMarker = null;
let placeService = null;
let markers = [];
let infoWindow = null;

const load = () => {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(resolve);
  })
  .then((geo) => {
    let pos = {
      lat: geo.coords.latitude,
      lng: geo.coords.longitude
    };
    map.setCenter(pos);
    map.setZoom(18);
    centerMarker.setPosition(pos);
  })
}

const createQuery = (name) => {
  return new Promise((resolve, reject) => {
    placeService.nearbySearch({
      bounds: map.getBounds(),
      name: name
    }, resolve);
  })
}

const query = () => {
  return Promise.all([
    createQuery('50嵐'),
    createQuery('茶湯會'),
    createQuery('迷客夏'),
    createQuery('大苑子')
  ])
  .then((result) => result.reduce((arr, r) => arr.concat(r), []))
  .then((result) => result.filter((r) => r))
  .then((places) => {
    infoWindow.close();
    markers.forEach((marker) => {
      marker.setMap(null);
      google.maps.event.remove
    });
    markers = places.map((place) => {
      let marker = new google.maps.Marker({
        map: map,
        position: place.geometry.location,
        title: place.name
      });
      google.maps.event.addListener(marker, 'click', () => {
        infoWindow.setContent(place.name);
        infoWindow.open(map, marker);
      });
      return marker;
    });
  });
}

let initMapPromise = new Promise((resolve, reject) => {
  window.initMap = () => {
    map = new google.maps.Map(document.querySelector('#map'));
    centerMarker = new google.maps.Marker({
      map: map,
      icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
    });
    placeService = new google.maps.places.PlacesService(map);
    infoWindow = new google.maps.InfoWindow();
    google.maps.event.addListener(map, 'tilesloaded', query);
    resolve();
  }
});

document.addEventListener('DOMContentLoaded', () => {
  initMapPromise.then(load);
});
</script>
<div id="map"></div>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5lDKm-C75C7WDZy3ALs-IpT0e9m4DllE&libraries=places&&callback=initMap" async defer></script>
</body>
</html>
